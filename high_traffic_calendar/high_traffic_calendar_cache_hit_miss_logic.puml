@startuml

actor User

rectangle "API Gateway" {
  [Create Event]
  [Update Event]
  [Delete Event]
  [Get Events]
}

rectangle "Web Server" {
  [Business Logic]
}

rectangle "MongoDB Cluster" {
  [Query Routers (mongos)]
  [Primary Node]
  [Secondary Node]
}

rectangle "Cache" {
  [Redis]
}

User --> "API Gateway": Request
"API Gateway" --> "Web Server": Forward Request
alt Cache Hit
  "Web Server" --> "Cache: Redis": Check Cache
  "Cache: Redis" --> "Web Server": Cache Hit
  "Web Server" --> "API Gateway": Return Cached Response
else Cache Miss
  "Web Server" --> "Cache: Redis": Check Cache
  "Cache: Redis" -> "Web Server": Cache Miss
  
  "Web Server" --> "Query Routers (mongos)": Query MongoDB
  "Query Routers (mongos)" --> "Primary Node": Forward Query
  "Primary Node" --> "Query Routers (mongos)": Return Data
  "Query Routers (mongos)" --> "Web Server": Return Data
  "Web Server" --> "Cache: Redis": Update Cache
  "Web Server" --> "API Gateway": Return Response
end

alt Event Create/Update/Delete
  "User" --> "API Gateway": Create/Update/Delete Request
  "API Gateway" --> "Web Server": Forward Request
  "Web Server" --> "Query Routers (mongos)": Update MongoDB
  "Query Routers (mongos)" --> "Primary Node": Forward Update
  "Primary Node" --> "Secondary Node": Replicate Data
  "Primary Node" --> "Query Routers (mongos)": Acknowledge Update
  "Query Routers (mongos)" --> "Web Server": Acknowledge Update
  
  "Web Server" --> "Cache: Redis": Invalidate Cache
  "Cache: Redis" --> "Web Server": Acknowledge Invalidation
  "Web Server" --> "API Gateway": Return Response
end

@enduml
