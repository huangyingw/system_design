@startuml
skinparam backgroundColor #FFFAFA
skinparam packageStyle rectangle
skinparam defaultFontName Arial
skinparam defaultFontSize 12
skinparam node {
    BackgroundColor lightblue
    BorderColor black
    FontName Arial
    FontSize 12
    RoundCorner 20
    Padding 10
}

' Define Brokers and Zookeeper
node "Zookeeper\n(物理)" as Zookeeper << (Z,yellow) >>

node "Broker1\n(物理)" as Broker1 << (K,orchid) >>
node "Broker2\n(物理)" as Broker2 << (K,orchid) >>
node "Broker3\n(物理)" as Broker3 << (K,orchid) >>
node "Broker4\n(物理)" as Broker4 << (K,orchid) >>

' Define internal components
node "Controller\n(Broker3)" as Controller << (C,lightblue) >>
node "Replication Manager\n(Broker3)" as ReplicationManager << (C,lightblue) >>
node "Log Manager\n(Broker3)" as LogManager << (C,lightblue) >>
node "Network Processor\n(Broker4)" as NetworkProcessor << (C,lightblue) >>
node "Request Handler\n(Broker1)" as RequestHandler << (C,lightblue) >>

' Arrange nodes for better layout
Zookeeper -down-> Broker1
Zookeeper -down-> Broker2
Zookeeper -down-> Broker3
Zookeeper -down-> Broker4

Broker1 -down-> RequestHandler
Broker3 -down-> Controller
Broker3 -down-> ReplicationManager
Broker3 -down-> LogManager
Broker4 -down-> NetworkProcessor

' Connections
Controller --> Zookeeper : "manages & coordinates"
Broker3 --> Controller : "hosts"
Broker3 --> ReplicationManager : "hosts"
Broker3 --> LogManager : "hosts"
Broker4 --> NetworkProcessor : "hosts"
Broker1 --> RequestHandler : "hosts"

Zookeeper -[dotted]-> Broker1 : "coordinates"
Zookeeper -[dotted]-> Broker2 : "coordinates"
Zookeeper -[dotted]-> Broker3 : "coordinates"
Zookeeper -[dotted]-> Broker4 : "coordinates"

' Annotations for clarity
note right of Zookeeper : "Zookeeper\nCluster Management & Coordination"
note right of Controller : "Controller\nCluster Leadership & Coordination"
note right of ReplicationManager : "Replication Manager\nManages Replication"
note right of LogManager : "Log Manager\nManages Logs"
note right of NetworkProcessor : "Network Processor\nHandles Network Requests"
note right of RequestHandler : "Request Handler\nProcesses Client Requests"

' 示例场景
note bottom of Broker3 : "Use case scenario:\nWhen Broker3 fails, the Replication Manager replicates its data to other brokers to ensure high availability."

@enduml
