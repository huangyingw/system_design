@startuml Real-time Chat System
' ==================== Enhanced Metadata ====================
' === 基础分类 ===
' @category: distributed-systems
' @subcategory: message-queue
' @tags: #kafka, #message-queue, #event-streaming, #distributed-systems
' @description: Real Time Chat System With Presence And Message Delivery Guarantees
'
' === 应用场景 ===
' @application: General
' @industry: Social Media, Media & Entertainment
' @use-cases: Real-time Processing, Search & Discovery, Log Aggregation
' @business-value: Improved scalability, High availability, Better performance, Cost efficiency
'
' === 技术栈 ===
' @tech-stack: Kafka, ZooKeeper, Redis, MongoDB, MySQL/PostgreSQL
' @programming-languages: Go
' @frameworks: Framework-agnostic
' @protocols: WebSocket
' @apis: REST API
'
' === 架构模式 ===
' @pattern: API Gateway
' @design-pattern: Observer, Producer-Consumer, Repository, Factory
' @data-flow: Bidirectional, Request-Response
' @communication-style: Asynchronous
'
' === 分布式特性 ===
' @cap-focus: AP (Availability + Partition Tolerance)
' @consistency-model: Eventual Consistency (configurable)
' @consensus-algorithm: Raft, Leader Election
' @partition-strategy: Hash-based, Key-based, Custom partitioning
'
' === 性能与扩展 ===
' @scale: Medium to Large (1K-100K users, 100-10K QPS)
' @scalability: Horizontal scaling, Auto-scaling, Load balancing
' @performance-metrics: Throughput: 1M+ msg/s, Latency: <10ms p99
' @optimization-techniques: Caching
' @throughput: Very High (1M+ messages/second)
' @latency: Low (<10ms p99)
'
' === 可靠性 ===
' @reliability: Replication, Redundancy, Health checks, Automatic recovery
' @fault-tolerance: Retry mechanism
' @disaster-recovery: Multi-datacenter replication, Backup strategies, RPO/RTO management
' @availability: 99.99% (4 nines)
' @data-durability: 99.999999999% (11 nines) with proper replication
'
' === 安全性 ===
' @security-features: Authentication
' @authentication: OAuth 2.0, JWT, API Keys, SASL
' @authorization: RBAC (Role-Based Access Control), ACLs, Policy-based
' @encryption: TLS (in-transit), Optional encryption at rest
' @compliance: GDPR-ready, SOC2, HIPAA-compatible, PCI-DSS
'
' === 存储 ===
' @storage-type: Log Storage
' @database-type: SQL/Relational, NoSQL, In-Memory
' @caching-strategy: Cache-aside, Write-through, TTL-based expiration
' @data-persistence: Disk-based with WAL, Configurable durability, Snapshot backups
'
' === 监控运维 ===
' @monitoring: Prometheus, Grafana, Custom metrics, Health checks
' @logging: Centralized logging (ELK/Splunk), Structured logs, Log aggregation
' @alerting: Prometheus Alertmanager, PagerDuty, Custom alerts, SLA monitoring
' @observability: Metrics (RED/USE), Logs, Distributed tracing (Jaeger/Zipkin)
'
' === 部署 ===
' @deployment: Kubernetes, Docker, Cloud-native, Blue-Green deployment
' @infrastructure: Cloud, On-premise, Hybrid, Multi-cloud
' @cloud-provider: AWS, Azure, GCP, Cloud-agnostic
' @containerization: Docker-ready, Container-friendly
'
' === 成本 ===
' @cost-factors: Compute instances, Storage costs, Network bandwidth, Licensing
' @cost-optimization: Reserved instances, Auto-scaling, Storage tiering, Compression, Resource right-sizing
' @resource-usage: CPU: Medium-High, Memory: Medium-High, Disk I/O: High, Network: Medium
'
' === 复杂度 ===
' @complexity: Medium
' @implementation-difficulty: Medium
' @maintenance-complexity: Medium
'
' === 学习 ===
' @difficulty-level: Intermediate
' @learning-value: Medium to High (practical system design)
' @prerequisites: Message queues, Pub-Sub pattern, Database fundamentals, SQL/NoSQL
' @related-concepts: Caching strategies, Cache invalidation
'
' === 数据特征 ===
' @data-volume: Medium to Large (GBs to TBs)
' @data-velocity: Real-time, High-speed streaming
' @data-variety: Structured, Semi-structured (JSON, Avro)
' @data-model: Document, Key-Value, Relational, Time-series
'
' === 集成 ===
' @integration-points: REST APIs, Message queues, Database connectors, Webhooks
' @third-party-services: Cloud storage, CDN, Payment processors, Analytics services
' @external-dependencies: Minimal external dependencies
'
' === 测试 ===
' @testing-strategy: Unit tests, Integration tests, Load tests, Chaos engineering
' @quality-assurance: CI/CD pipelines, Code review, Static analysis, Performance testing
'
' === 版本 ===
' @version: 1.0 (current design)
' @maturity: Production-ready, Battle-tested
' @evolution-stage: Active development, Continuous improvement
'
' === 关联 ===
' @related-files: See other architecture diagrams in the same directory
' @alternatives: Multiple implementation approaches available
' @comparison-with: Traditional monolithic vs distributed approaches
'
' === 实战 ===
' @real-world-examples: LinkedIn, Netflix, Uber, Airbnb
' @companies-using: LinkedIn, Netflix, Uber, Airbnb
' @production-readiness: Production-ready, Battle-tested at scale, Enterprise-grade
' ==================================================



!include common_style.puml

title Real-time Chat System with Presence and Message Delivery Guarantees

' Container definition
rectangle "Client Layer" {
    component "Web Client" as webClient
    component "Mobile Client" as mobileClient
    component "Desktop Client" as desktopClient
}

rectangle "Load Balancer Layer" {
    component "API Gateway" as apiGateway
    component "WebSocket Gateway" as wsGateway
}

rectangle "Service Layer" {
    component "Authentication Service" as authService
    component "Chat Service" as chatService
    component "Presence Service" as presenceService
    component "Notification Service" as notificationService
    component "Message Delivery Service" as deliveryService
}

rectangle "Real-time Layer" {
    queue "Message Queue (Kafka)" as messageQueue
    component "WebSocket Manager" as wsManager
    component "Push Notification Service" as pushService
}

rectangle "Storage Layer" {
    database "User DB\n(PostgreSQL)" as userDB
    database "Message DB\n(MongoDB)" as messageDB
    database "Presence Cache\n(Redis)" as presenceCache
    database "Session Store\n(Redis)" as sessionStore
}

' Connections
webClient --> apiGateway
mobileClient --> apiGateway
desktopClient --> apiGateway
webClient --> wsGateway
mobileClient --> wsGateway
desktopClient --> wsGateway

apiGateway --> authService
apiGateway --> chatService
wsGateway --> wsManager

authService --> userDB
authService --> sessionStore

chatService --> messageQueue
chatService --> messageDB
chatService --> presenceService

presenceService --> presenceCache
presenceService --> messageQueue

wsManager --> messageQueue
wsManager --> sessionStore
wsManager --> presenceCache

messageQueue --> deliveryService
deliveryService --> messageDB
deliveryService --> pushService

notificationService --> pushService
pushService --> mobileClient

note right of presenceService
  Handles user online/offline status
  Last seen tracking
  Typing indicators
end note

note right of deliveryService
  Ensures message delivery
  Handles retry logic
  Manages acknowledgments
end note

note right of messageQueue
  Handles high throughput
  Message ordering
  Fault tolerance
end note

note right of messageDB
  Stores message history
  Supports message search
  Handles media attachments
end note

@enduml 