@startuml PayPal Idempotency Architecture
' ==================== Metadata ====================
' @category: distributed-systems
' @tags: #paypal-core, #idempotency, #payment-processing, #architecture, #redis, #postgresql
' @application: PayPal
' @tech-stack: Redis, PostgreSQL, Kafka, Load Balancer
' @pattern: Idempotency, High Availability
' @description: PayPal幂等性系统架构设计 - 完整的技术栈和组件关系
' @interview-focus: HIGH
' ==================================================

!include common_style.puml

title PayPal幂等性系统 - 完整架构设计

' 定义颜色
!define CLIENT_COLOR #E3F2FD
!define GATEWAY_COLOR #81D4FA
!define IDEM_COLOR #FFD54F
!define PAYMENT_COLOR #A5D6A7
!define CACHE_COLOR #EF5350
!define DB_COLOR #42A5F5
!define MQ_COLOR #FF7043

skinparam componentStyle rectangle

' ================================
' 客户端层
' ================================
rectangle "客户端层" as ClientLayer CLIENT_COLOR {
    component "Web App" as WebApp
    component "Mobile App" as MobileApp
    component "Merchant API" as MerchantAPI

    note right of WebApp
        **幂等性键生成规则**:
        - UUID v4 (随机)
        - 客户端生成
        - 每个支付操作唯一
        - 格式: {user_id}_{timestamp}_{uuid}
    end note
}

' ================================
' 负载均衡层
' ================================
component "Load Balancer\n(Nginx/AWS ELB)" as LB #BBDEFB {
}

' ================================
' API网关层
' ================================
rectangle "API网关层" as GatewayLayer GATEWAY_COLOR {
    component "API Gateway\nCluster" as APIGateway {
        component "Rate Limiter" as RateLimiter
        component "Authentication" as Auth
        component "Request Router" as Router
    }

    note right of APIGateway
        **网关职责**:
        1. 验证幂等性键格式
        2. 提取Idempotency-Key header
        3. 限流保护
        4. 认证授权
    end note
}

' ================================
' 幂等性服务层
' ================================
rectangle "幂等性服务层" as IdemLayer IDEM_COLOR {
    component "Idempotency Service\nCluster (3+ nodes)" as IdemService {
        component "Key Validator" as KeyValidator
        component "State Manager" as StateManager
        component "Cache Manager" as CacheManager
    }

    note right of IdemService
        **核心逻辑**:
        1. 检查Redis缓存
        2. 检查数据库记录
        3. 管理状态转换
        4. 回填缓存
        5. 处理并发冲突
    end note
}

' ================================
' 缓存层
' ================================
rectangle "分布式缓存层" as CacheLayer CACHE_COLOR {
    database "Redis Cluster\n(Master-Slave)" as RedisCluster {
        component "Redis Master 1" as RedisMaster1
        component "Redis Slave 1" as RedisSlave1
        component "Redis Master 2" as RedisMaster2
        component "Redis Slave 2" as RedisSlave2
        component "Redis Sentinel" as Sentinel
    }

    note right of RedisCluster
        **缓存策略**:
        - Key格式: idempotency:{uuid}
        - Value: JSON {status, result, timestamp}
        - TTL: 成功=24h, 失败=1h
        - 使用SET NX确保原子性
        - 主从复制，高可用
    end note
}

' ================================
' 支付处理层
' ================================
rectangle "支付处理层" as PaymentLayer PAYMENT_COLOR {
    component "Payment Orchestrator" as PaymentOrch
    component "Payment Processor" as PaymentProc
    component "Fraud Detector" as FraudDetector
    component "Account Service" as AccountService
}

' ================================
' 数据持久化层
' ================================
rectangle "数据持久化层" as DBLayer DB_COLOR {
    database "PostgreSQL\nPrimary-Replica" as PostgreSQL {
        component "Primary DB" as PrimaryDB
        component "Replica DB 1" as ReplicaDB1
        component "Replica DB 2" as ReplicaDB2
    }

    note right of PostgreSQL
        **数据库表**:
        - transactions (交易主表)
        - idempotency_keys (幂等性记录)
        - accounts (账户余额)
        - audit_log (审计日志)

        **保留策略**:
        - 热数据: 30天
        - 冷数据: 归档到S3
        - 审计日志: 7年
    end note
}

' ================================
' 消息队列层
' ================================
rectangle "异步消息层" as MQLayer MQ_COLOR {
    queue "Kafka Cluster" as KafkaCluster {
        component "payment-events" as PaymentTopic
        component "idempotency-events" as IdemTopic
    }
}

' ================================
' 监控告警层
' ================================
rectangle "监控告警层" as MonitorLayer #E1BEE7 {
    component "Prometheus" as Prometheus
    component "Grafana" as Grafana
    component "Alert Manager" as AlertManager
}

' ================================
' 连接关系
' ================================

' 客户端到网关
WebApp --> LB
MobileApp --> LB
MerchantAPI --> LB

LB --> APIGateway

' 网关到幂等性服务
APIGateway --> IdemService : 1. 检查幂等性键

' 幂等性服务到缓存
IdemService --> RedisCluster : 2. 查询/设置缓存
IdemService <--> PostgreSQL : 3. 兜底查询/持久化

' 幂等性服务到支付层
IdemService --> PaymentOrch : 4. 转发支付请求

' 支付处理流程
PaymentOrch --> FraudDetector : 5a. 风控检测
PaymentOrch --> PaymentProc : 5b. 执行支付
PaymentProc --> AccountService : 6. 扣减余额
PaymentProc --> PostgreSQL : 7. 写入交易

' 支付结果回传
PaymentProc --> IdemService : 8. 返回支付结果
IdemService --> RedisCluster : 9. 更新缓存状态

' 异步通知
PaymentProc --> KafkaCluster : 10. 发送事件

' 监控
IdemService --> Prometheus : 上报指标
PaymentLayer --> Prometheus : 上报指标
Prometheus --> Grafana : 可视化
Prometheus --> AlertManager : 告警

' ================================
' 关键设计说明
' ================================

note bottom of IdemLayer
    **幂等性服务性能指标**:
    - QPS: 10,000+ (单节点)
    - P99延迟: <10ms (Redis命中)
    - P99延迟: <50ms (DB兜底)
    - 可用性: 99.99%

    **扩展策略**:
    - 水平扩展: 3-10个节点
    - 无状态设计: 可随意扩缩容
    - 客户端负载均衡
end note

note bottom of CacheLayer
    **Redis高可用架构**:
    - Redis Cluster模式（分片）
    - 主从复制（每个分片）
    - Sentinel监控（自动故障转移）
    - 持久化: AOF + RDB

    **容量规划**:
    - 每个幂等性键: ~1KB
    - 保留24小时
    - 100万TPS = 86TB/天
    - 实际: 压缩 + 过期 = 10-20GB
end note

note bottom of DBLayer
    **PostgreSQL高可用**:
    - 主从复制（同步/异步）
    - Failover自动切换
    - 连接池: PgBouncer

    **分片策略**:
    - 按user_id哈希分片
    - 16-32个分片
    - 每个分片: 1-10TB
end note

' ================================
' 故障场景处理
' ================================

legend right
    **故障场景与降级策略**

    **场景1: Redis宕机**
    → 降级到PostgreSQL查询
    → P99延迟上升 10ms → 50ms
    → 仍然保证幂等性

    **场景2: PostgreSQL主库宕机**
    → 自动故障转移到Replica
    → 30秒内恢复
    → 幂等性服务重试机制

    **场景3: 幂等性服务节点宕机**
    → 负载均衡自动剔除故障节点
    → 剩余节点承载流量
    → 无单点故障

    **场景4: 网络分区**
    → Redis Sentinel选举新主
    → 客户端重试机制
    → 幂等性确保不重复处理

    **场景5: 缓存雪崩**
    → 设置随机过期时间(±10%)
    → 布隆过滤器防止缓存穿透
    → 限流保护数据库
endlegend

@enduml
