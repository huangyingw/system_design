@startuml Telegram_Multi_Device_Sync_Optimized
!define RECTANGLE component
!define DATABASE database
!define QUEUE queue

skinparam backgroundColor #F0F0F0
skinparam handwritten false
skinparam monochrome true
skinparam packageStyle rectangle
skinparam defaultFontName Arial
skinparam defaultFontSize 12

RECTANGLE "User Devices" {
    [Mobile App]
    [Desktop Client]
    [Web Client]
}

RECTANGLE "API Gateway" {
    [Load Balancer]
    [Rate Limiter]
    [Auth Service]
}

RECTANGLE "Sync Service Cluster" {
    [Device Manager]
    [Message Synchronizer]
    [State Reconciliation]
}

DATABASE "Message Store" {
    [Cassandra Cluster]
    note right: Sharding Key: user_id
}

DATABASE "Device Registry" {
    [Redis Cluster]
    note right: Key: user_id:device_id
}

RECTANGLE "Key Management Service" {
    [Key Distribution]
    [Key Rotation]
    [HSM]
}

QUEUE "Message Queue" {
    [Kafka Cluster]
}

RECTANGLE "Push Notification Service" {
    [Notification Dispatcher]
}

RECTANGLE "Caching Layer" {
    [Redis Cache]
}

"User Devices" <--> "API Gateway" : HTTPS
"API Gateway" <--> "Sync Service Cluster" : Internal API
"Sync Service Cluster" <--> "Message Store" : Read/Write
"Sync Service Cluster" <--> "Device Registry" : Manage Devices
"Sync Service Cluster" <--> "Key Management Service" : Encryption Keys
"Sync Service Cluster" --> "Message Queue" : Publish Changes
"Message Queue" --> "Push Notification Service" : Consume Events
"Push Notification Service" --> "User Devices" : Send Notifications
"Sync Service Cluster" <--> "Caching Layer" : Cache Data

@enduml
