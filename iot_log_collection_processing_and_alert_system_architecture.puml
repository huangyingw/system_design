@startuml
!theme toy
skinparam linetype ortho
skinparam backgroundColor #F0F8FF
skinparam ArrowColor #4B0082
skinparam ArrowFontColor #4B0082

rectangle "Data Generation Layer" {
    [IoT Devices] as IoT #LightCyan
}

rectangle "Data Collection Layer" {
    [Log Collector] as Collector #LightGreen
}

rectangle "Data Processing Layer" {
    queue "Kafka Queue" as Kafka #LightPink
    [Log Processing Service] as LogProcessor #LightYellow
    [Stream Processing (Flink/Spark)] as StreamProcessor #LightSalmon
}

database "Data Storage Layer" {
    database "Master Database" as MasterDB #PaleGoldenrod {
        note right
            Composite Sharding Strategy:
            - By Device
            - By Time
            PK, Index Optimization
        end note
    }
    database "Replica Database" as ReplicaDB #PaleGoldenrod
    database "Statistics Database" as StatsDB #Thistle {
        note right
            Sharding Key: 
            Time + Device Type
        end note
    }
}

rectangle "Application Service Layer" {
    [Query Service] as QueryService #LightSteelBlue
    [Alert Service] as AlertService #LightCoral
    [API Server] as APIServer #LightSeaGreen
}

IoT -[#4B0082]-> Collector : Send logs
Collector -[#4B0082]-> Kafka : Push logs
Kafka -[#4B0082]-> LogProcessor : Transmit logs
Kafka -[#4B0082]-> StreamProcessor : Stream processing
LogProcessor -[#4B0082]-> MasterDB : Store processed logs
MasterDB -[#4B0082]-> ReplicaDB : Data replication
ReplicaDB -[#4B0082]-> QueryService : Query logs
ReplicaDB -[#4B0082]-> AlertService : Analyze and generate alerts
StreamProcessor -[#4B0082]-> StatsDB : Store statistical results
StatsDB -[#4B0082]-> APIServer : Retrieve statistical data

note bottom of MasterDB
    Redis cache key design:
    device:{deviceId}:logs:{timestamp}
end note
@enduml
