@startuml Twitter Comment System Design

!define FONTNAME Roboto
!define FONTSIZE 12
!define TITLEFONTSIZE 18

skinparam backgroundColor #E0E8F0
skinparam defaultFontName FONTNAME
skinparam defaultFontSize FONTSIZE
skinparam roundcorner 10
skinparam shadowing false
skinparam ArrowColor #2C3E50
skinparam ArrowThickness 1.2
skinparam rectangleBorderColor #34495E
skinparam rectangleBackgroundColor #ECF0F1
skinparam databaseBorderColor #16A085
skinparam databaseBackgroundColor #D1F2EB
skinparam queueBorderColor #8E44AD
skinparam queueBackgroundColor #E8DAEF
skinparam noteBorderColor #F39C12
skinparam noteBackgroundColor #FCF3CF

title <font size=TITLEFONTSIZE>Twitter Comment System Design: Comment Flow</font>

actor User

rectangle "User Interface" as UI {
    [Web & Mobile Apps]
}

cloud "CDN" as CDN

rectangle "API Gateway" as APIGateway {
    [Load Balancer]
    [Auth & Rate Limiting]
}

rectangle "Microservices" as Microservices {
    [Comment Service]
    [User Service]
    [Tweet Service]
    [Notification Service]
    [Moderation Service]
}

database "Data Storage" as DataStorage {
    [Comment DB]
    [User DB]
    [Tweet DB]
}

rectangle "Cache Layer" as CacheLayer {
    [Redis Cluster]
}

queue "Message Queue" as MessageQueue {
    [Kafka]
}

database "Search Engine" as SearchEngine {
    [Elasticsearch]
}

rectangle "ML & Analytics" as MLAnalytics {
    [Sentiment Analysis]
    [Content Moderation]
}

User -[#3498DB]right-> UI : "1. Post comment"
UI -[#3498DB]down-> CDN
CDN -[#3498DB]down-> APIGateway
APIGateway -[#3498DB]down-> Microservices : "2. Route request"
Microservices -[#3498DB]right-> CacheLayer : "3. Check cache"
Microservices -[#3498DB]down-> DataStorage : "4. Store comment"
Microservices -[#3498DB]left-> MessageQueue : "5. Publish event"
MessageQueue -[#3498DB]-> Microservices : "6. Process event"
Microservices -[#3498DB]-> MLAnalytics : "7. Analyze content"
MLAnalytics -[#3498DB]-> Microservices : "8. Return analysis"
Microservices -[#3498DB]right-> SearchEngine : "9. Index comment"
Microservices -[#3498DB]up-> APIGateway : "10. Return response"
APIGateway -[#3498DB]up-> CDN
CDN -[#3498DB]up-> UI
UI -[#3498DB]left-> User : "11. Display comment"

note right of UI
  Features:
  - Real-time updates
  - Infinite scrolling
  - Rich text editor
end note

note right of APIGateway
  - Rate limiting
  - Authentication
  - Load balancing
end note

note right of Microservices
  Comment Service:
  - CRUD operations
  - Tree structure
  - Sorting & pagination
end note

note bottom of DataStorage
  - Sharding by tweet_id
  - Multi-region replication
  - Data encryption
end note

note bottom of CacheLayer
  key: tweet_id
  value: {comments, user_info}
end note

note bottom of MLAnalytics
  - Spam detection
  - Content moderation
  - Sentiment analysis
end note

@enduml