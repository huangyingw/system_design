@startuml PayPal Refund System
' ==================== Metadata ====================
' @category: distributed-systems
' @tags: #paypal-core, #refund, #chargeback, #payment-processing, #idempotency, #state-machine, #reconciliation, #audit-trail, #distributed-transaction, #saga, #compensation, #interview-relevant, #trade-offs
' @application: PayPal
' @tech-stack: PostgreSQL, Redis, Kafka
' @pattern: Saga Pattern, Idempotency, State Machine, Compensation Transaction
' @description: PayPalé€€æ¬¾ç³»ç»Ÿ - å…¨é¢é€€æ¬¾ã€éƒ¨åˆ†é€€æ¬¾ã€äº‰è®®é€€æ¬¾(Chargeback)çš„å®Œæ•´æµç¨‹
' @interview-focus: MEDIUM
' ==================================================

!include common_style.puml

title PayPal Refund System - é€€æ¬¾ä¸Chargebackå¤„ç†

skinparam sequenceMessageAlign center
skinparam responseMessageBelowArrow true

actor "Merchant\n(å•†æˆ·)" as Merchant
participant "API Gateway" as Gateway #LightBlue
participant "Refund Service" as RefundService #Gold
participant "Payment Service" as PaymentService #LightGreen
database "PostgreSQL" as DB #SkyBlue
database "Redis" as Redis #Red
queue "Kafka" as Kafka #Orange
participant "3rd Party\nPayment Provider" as Provider #Lavender

== åœºæ™¯1: å…¨é¢é€€æ¬¾ï¼ˆFull Refundï¼‰ ==

Merchant -> Gateway: POST /refunds\n{payment_id: "pay-123",\nrefund_amount: 100,\nreason: "Customer request"}

note right of Merchant
  **é€€æ¬¾è§¦å‘åŸå› **:
  - å®¢æˆ·ç”³è¯·é€€æ¬¾
  - å•†å“æœªæ”¶åˆ°
  - å•†å“æŸå
  - è®¢å•å–æ¶ˆ
end note

Gateway -> RefundService: 1. åˆ›å»ºé€€æ¬¾è¯·æ±‚

activate RefundService
RefundService -> DB: 2. æŸ¥è¯¢åŸæ”¯ä»˜è®°å½•\nSELECT * FROM transactions\nWHERE payment_id = 'pay-123'

DB --> RefundService: {amount: 100, status: SUCCESS,\nuser_id: 'U1', merchant_id: 'M1',\nthird_party_txn_id: 'ext-456'}

note right of RefundService
  **é€€æ¬¾å‰éªŒè¯**:
  1. åŸæ”¯ä»˜æ˜¯å¦å­˜åœ¨
  2. åŸæ”¯ä»˜æ˜¯å¦æˆåŠŸ
  3. æ˜¯å¦å·²å…¨é¢é€€æ¬¾
  4. é€€æ¬¾é‡‘é¢æ˜¯å¦åˆæ³•
end note

RefundService -> RefundService: 3. éªŒè¯é€€æ¬¾é‡‘é¢\n100 <= 100 âœ…

RefundService -> DB: 4. BEGIN TRANSACTION

RefundService -> DB: 5. åˆ›å»ºé€€æ¬¾è®°å½•\nINSERT INTO refunds\n(refund_id, payment_id,\namount, status, reason)\nVALUES ('ref-789', 'pay-123',\n100, 'PENDING', 'Customer request')

note right of DB
  **é€€æ¬¾çŠ¶æ€æœº**:
  PENDING â†’ PROCESSING â†’ SUCCESS
          â†’ PROCESSING â†’ FAILED
end note

RefundService -> DB: 6. æ›´æ–°æ”¯ä»˜çŠ¶æ€\nUPDATE transactions\nSET refund_status = 'REFUNDED',\n    refund_amount = 100\nWHERE payment_id = 'pay-123'

RefundService -> DB: 7. COMMIT TRANSACTION

RefundService -> Provider: 8. è°ƒç”¨ç¬¬ä¸‰æ–¹é€€æ¬¾API\nrefund(txn_id: 'ext-456',\namount: 100)

note right of Provider
  **ç¬¬ä¸‰æ–¹é€€æ¬¾**:
  - ä¿¡ç”¨å¡é€€æ¬¾ï¼ˆ1-5å·¥ä½œæ—¥ï¼‰
  - é“¶è¡Œè½¬è´¦é€€æ¬¾ï¼ˆå³æ—¶ï¼‰
  - æ•°å­—é’±åŒ…é€€æ¬¾ï¼ˆå³æ—¶ï¼‰
end note

alt ç¬¬ä¸‰æ–¹é€€æ¬¾æˆåŠŸ
    Provider --> RefundService: âœ… é€€æ¬¾æˆåŠŸ\n{refund_id: 'ext-ref-999'}

    RefundService -> DB: 9. BEGIN TRANSACTION

    RefundService -> DB: 10. æ›´æ–°é€€æ¬¾çŠ¶æ€\nUPDATE refunds\nSET status = 'SUCCESS',\n    third_party_refund_id = 'ext-ref-999',\n    completed_at = NOW()\nWHERE refund_id = 'ref-789'

    RefundService -> DB: 11. æ›´æ–°å•†æˆ·ä½™é¢ï¼ˆæ‰£æ¬¾ï¼‰\nUPDATE merchant_accounts\nSET balance = balance - 100\nWHERE merchant_id = 'M1'\nAND balance >= 100

    note right of DB
      **å•†æˆ·ä½™é¢æ‰£å‡**:
      - é€€æ¬¾ä»å•†æˆ·è´¦æˆ·æ‰£é™¤
      - ä½¿ç”¨æ‚²è§‚é”ï¼ˆFOR UPDATEï¼‰
      - å¦‚æœä½™é¢ä¸è¶³ï¼Œæš‚ç¼“é€€æ¬¾
    end note

    RefundService -> DB: 12. æ›´æ–°ç”¨æˆ·ä½™é¢ï¼ˆé€€æ¬¾ï¼‰\nUPDATE accounts\nSET balance = balance + 100\nWHERE user_id = 'U1'

    RefundService -> DB: 13. è®°å½•ä½™é¢å˜æ›´\nINSERT INTO balance_transactions\n(account_id, amount, txn_type,\nbalance_before, balance_after)\nVALUES (..., 100, 'REFUND', ...)

    RefundService -> DB: 14. COMMIT TRANSACTION

    RefundService -> Kafka: 15. å‘é€é€€æ¬¾æˆåŠŸäº‹ä»¶\nRefundCompletedEvent

    note right of Kafka
      **äº‹ä»¶æ¶ˆè´¹è€…**:
      - é€šçŸ¥æœåŠ¡ï¼ˆé‚®ä»¶/çŸ­ä¿¡ï¼‰
      - è®¢å•æœåŠ¡ï¼ˆæ›´æ–°è®¢å•çŠ¶æ€ï¼‰
      - æ•°æ®ä»“åº“ï¼ˆæŠ¥è¡¨ï¼‰
    end note

    RefundService --> Gateway: 200 OK\n{refund_id: 'ref-789',\nstatus: 'SUCCESS'}
    deactivate RefundService
    Gateway --> Merchant: âœ… é€€æ¬¾æˆåŠŸ

else ç¬¬ä¸‰æ–¹é€€æ¬¾å¤±è´¥
    Provider --> RefundService: âŒ é€€æ¬¾å¤±è´¥\n{error: "Insufficient funds"}

    RefundService -> DB: 9. æ›´æ–°é€€æ¬¾çŠ¶æ€\nUPDATE refunds\nSET status = 'FAILED',\n    error_message = 'Insufficient funds'\nWHERE refund_id = 'ref-789'

    RefundService -> Kafka: 10. å‘é€é€€æ¬¾å¤±è´¥äº‹ä»¶\nRefundFailedEvent

    RefundService --> Gateway: 400 Bad Request\n{error: "Refund failed"}
    deactivate RefundService
    Gateway --> Merchant: âŒ é€€æ¬¾å¤±è´¥
end

== åœºæ™¯2: éƒ¨åˆ†é€€æ¬¾ï¼ˆPartial Refundï¼‰ ==

Merchant -> Gateway: POST /refunds\n{payment_id: "pay-123",\nrefund_amount: 50,\nreason: "Partial return"}

note right of Merchant
  **éƒ¨åˆ†é€€æ¬¾åœºæ™¯**:
  - å®¢æˆ·é€€å›éƒ¨åˆ†å•†å“
  - ä»·æ ¼è°ƒæ•´
  - æŠ˜æ‰£è¡¥å¿
end note

Gateway -> RefundService: 1. åˆ›å»ºé€€æ¬¾è¯·æ±‚

activate RefundService
RefundService -> DB: 2. æŸ¥è¯¢åŸæ”¯ä»˜å’Œé€€æ¬¾å†å²\nSELECT * FROM transactions t\nLEFT JOIN refunds r\nON t.payment_id = r.payment_id\nWHERE t.payment_id = 'pay-123'

DB --> RefundService: åŸé‡‘é¢: 100\nå·²é€€æ¬¾: 30\nå¯é€€æ¬¾: 70

RefundService -> RefundService: 3. éªŒè¯é€€æ¬¾é‡‘é¢\n50 <= 70 âœ…

note right of RefundService
  **éƒ¨åˆ†é€€æ¬¾éªŒè¯**:
  1. ç´¯è®¡é€€æ¬¾é‡‘é¢ä¸èƒ½è¶…è¿‡åŸæ”¯ä»˜é‡‘é¢
  2. è®¡ç®—å…¬å¼ï¼š
     å¯é€€æ¬¾ = åŸæ”¯ä»˜é‡‘é¢ - å·²é€€æ¬¾é‡‘é¢
  3. å…è®¸å¤šæ¬¡éƒ¨åˆ†é€€æ¬¾
end note

RefundService -> DB: 4. åˆ›å»ºé€€æ¬¾è®°å½•\nINSERT INTO refunds\n(refund_id, payment_id,\namount, type)\nVALUES ('ref-790', 'pay-123',\n50, 'PARTIAL')

RefundService -> Provider: 5. è°ƒç”¨ç¬¬ä¸‰æ–¹é€€æ¬¾API\nrefund(amount: 50)

Provider --> RefundService: âœ… é€€æ¬¾æˆåŠŸ

RefundService -> DB: 6. æ›´æ–°æ”¯ä»˜è®°å½•\nUPDATE transactions\nSET refund_amount = refund_amount + 50\nWHERE payment_id = 'pay-123'

note right of DB
  **ç´¯è®¡é€€æ¬¾é‡‘é¢**:
  - åŸrefund_amount: 30
  - æ–°refund_amount: 30 + 50 = 80
  - å‰©ä½™å¯é€€: 100 - 80 = 20
end note

RefundService -> DB: 7. æ›´æ–°ä½™é¢ï¼ˆåŒå…¨é¢é€€æ¬¾æµç¨‹ï¼‰

RefundService --> Gateway: 200 OK\n{refund_id: 'ref-790',\nremaining_refundable: 20}
deactivate RefundService
Gateway --> Merchant: âœ… éƒ¨åˆ†é€€æ¬¾æˆåŠŸ

== åœºæ™¯3: äº‰è®®é€€æ¬¾ï¼ˆChargebackï¼‰ ==

actor "Cardholder\n(æŒå¡äºº)" as Cardholder
participant "Card Network\n(å¡ç»„ç»‡)" as CardNetwork #LightPink

note over Cardholder, CardNetwork
  **Chargebackåœºæ™¯**:
  æŒå¡äººå‘é“¶è¡Œå‘èµ·äº‰è®®
  - æœªæˆæƒäº¤æ˜“ï¼ˆç›—åˆ·ï¼‰
  - å•†å“æœªæ”¶åˆ°
  - å•†å“ä¸æè¿°ä¸ç¬¦
  - é‡å¤æ‰£æ¬¾
end note

Cardholder -> CardNetwork: 1. å‘èµ·Chargeback\n(äº‰è®®æ”¯ä»˜ pay-123)

CardNetwork -> Provider: 2. Chargebacké€šçŸ¥

Provider -> RefundService: 3. Webhookå›è°ƒ\nChargeback Notification\n{payment_id: 'pay-123',\nreason: 'FRAUD',\namount: 100}

activate RefundService
RefundService -> DB: 4. BEGIN TRANSACTION

RefundService -> DB: 5. åˆ›å»ºChargebackè®°å½•\nINSERT INTO chargebacks\n(chargeback_id, payment_id,\namount, reason, status)\nVALUES ('cb-111', 'pay-123',\n100, 'FRAUD', 'PENDING')

note right of DB
  **ChargebackçŠ¶æ€æœº**:
  PENDING â†’ UNDER_REVIEW â†’ ACCEPTED
          â†’ UNDER_REVIEW â†’ REJECTED
end note

RefundService -> DB: 6. å†»ç»“å•†æˆ·èµ„é‡‘\nUPDATE merchant_accounts\nSET pending_balance = pending_balance + 100\nWHERE merchant_id = 'M1'

note right of DB
  **èµ„é‡‘å†»ç»“**:
  - ä»å¯ç”¨ä½™é¢è½¬åˆ°å†»ç»“ä½™é¢
  - å•†æˆ·ä¸èƒ½æç°
  - ç­‰å¾…äº‰è®®ç»“æœ
end note

RefundService -> DB: 7. æ›´æ–°æ”¯ä»˜çŠ¶æ€\nUPDATE transactions\nSET status = 'CHARGEBACK_PENDING'\nWHERE payment_id = 'pay-123'

RefundService -> DB: 8. COMMIT TRANSACTION

RefundService -> Kafka: 9. å‘é€Chargebackäº‹ä»¶\nChargebackInitiatedEvent

RefundService --> Merchant: ğŸ“§ é‚®ä»¶é€šçŸ¥å•†æˆ·\nChargeback Alert

note right of Merchant
  **å•†æˆ·åº”å¯¹**:
  - æä¾›è¯æ®ï¼ˆå‘è´§è®°å½•ï¼‰
  - æä¾›æ²Ÿé€šè®°å½•
  - 45å¤©å†…å“åº”
  - å¦åˆ™è‡ªåŠ¨åˆ¤å®šä¸ºè´¥è¯‰
end note

deactivate RefundService

... 45å¤©åï¼Œäº‰è®®ç»“æœ ...

alt Chargebackè¢«æ‹’ç»ï¼ˆå•†æˆ·èƒœè¯‰ï¼‰
    CardNetwork -> Provider: Chargeback Rejected

    Provider -> RefundService: Webhook: Chargeback Rejected

    activate RefundService
    RefundService -> DB: 10. æ›´æ–°ChargebackçŠ¶æ€\nUPDATE chargebacks\nSET status = 'REJECTED'\nWHERE chargeback_id = 'cb-111'

    RefundService -> DB: 11. è§£å†»å•†æˆ·èµ„é‡‘\nUPDATE merchant_accounts\nSET pending_balance = pending_balance - 100\nWHERE merchant_id = 'M1'

    RefundService -> DB: 12. æ¢å¤æ”¯ä»˜çŠ¶æ€\nUPDATE transactions\nSET status = 'SUCCESS'\nWHERE payment_id = 'pay-123'

    RefundService -> Kafka: 13. å‘é€äº‹ä»¶\nChargebackRejectedEvent

    RefundService --> Merchant: ğŸ“§ å¥½æ¶ˆæ¯ï¼šäº‰è®®è¢«æ‹’ç»
    deactivate RefundService

else Chargebackè¢«æ¥å—ï¼ˆå•†æˆ·è´¥è¯‰ï¼‰
    CardNetwork -> Provider: Chargeback Accepted

    Provider -> RefundService: Webhook: Chargeback Accepted

    activate RefundService
    RefundService -> DB: 10. æ›´æ–°ChargebackçŠ¶æ€\nUPDATE chargebacks\nSET status = 'ACCEPTED'\nWHERE chargeback_id = 'cb-111'

    RefundService -> DB: 11. ä»å•†æˆ·è´¦æˆ·æ‰£æ¬¾\nUPDATE merchant_accounts\nSET balance = balance - 100,\n    pending_balance = pending_balance - 100\nWHERE merchant_id = 'M1'

    RefundService -> DB: 12. é€€æ¬¾ç»™ç”¨æˆ·\nUPDATE accounts\nSET balance = balance + 100\nWHERE user_id = 'U1'

    RefundService -> DB: 13. è®°å½•ä½™é¢å˜æ›´\nINSERT INTO balance_transactions...

    RefundService -> DB: 14. æ›´æ–°æ”¯ä»˜çŠ¶æ€\nUPDATE transactions\nSET status = 'CHARGEDBACK'\nWHERE payment_id = 'pay-123'

    RefundService -> Kafka: 15. å‘é€äº‹ä»¶\nChargebackAcceptedEvent

    RefundService --> Merchant: ğŸ“§ åæ¶ˆæ¯ï¼šäº‰è®®è¢«æ¥å—\nå·²ä»è´¦æˆ·æ‰£æ¬¾
    deactivate RefundService
end

== å¹‚ç­‰æ€§ä¿è¯ ==

note over Merchant, DB
  **é€€æ¬¾å¹‚ç­‰æ€§è®¾è®¡**:

  **åœºæ™¯**ï¼šå•†æˆ·é‡å¤ç‚¹å‡»é€€æ¬¾æŒ‰é’®

  **è§£å†³æ–¹æ¡ˆ**ï¼š
  1. å®¢æˆ·ç«¯ç”Ÿæˆå¹‚ç­‰æ€§é”®ï¼ˆIdempotency-Keyï¼‰
  2. Redisç¼“å­˜é€€æ¬¾ç»“æœï¼ˆ24å°æ—¶ï¼‰
  3. æ•°æ®åº“UNIQUEçº¦æŸï¼ˆpayment_id + idempotency_keyï¼‰

  **SQL**ï¼š
  ```sql
  INSERT INTO refunds (
    refund_id, payment_id, idempotency_key, amount
  ) VALUES (
    'ref-789', 'pay-123', 'uuid-abc', 100
  ) ON CONFLICT (payment_id, idempotency_key) DO NOTHING;
  ```

  å¦‚æœè¿”å›0è¡Œ â†’ é‡å¤è¯·æ±‚ï¼Œè¿”å›ç¼“å­˜ç»“æœ
end note

@enduml
