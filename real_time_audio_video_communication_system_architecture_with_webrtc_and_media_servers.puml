@startuml ' ==================== Metadata ====================
' ==================== Enhanced Metadata ====================
' === 基础分类 ===
' @category: database
' @subcategory: architecture
' @tags: #database, #websocket
' @description: Real Time Audio Video Communication System Architecture With Webrtc And Media Servers
'
' === 应用场景 ===
' @application: General
' @industry: IoT, Media & Entertainment
' @use-cases: Real-time Processing, Data Analytics, Log Aggregation
' @business-value: Improved scalability, High availability, Better performance, Cost efficiency
'
' === 技术栈 ===
' @tech-stack: WebSocket
' @programming-languages: Scala
' @frameworks: Framework-agnostic
' @protocols: WebSocket
' @apis: REST API
'
' === 架构模式 ===
' @pattern: Layered Architecture, Client-Server
' @design-pattern: Observer, Producer-Consumer, Repository, Factory
' @data-flow: Client → Gateway → Service → Database
' @communication-style: Synchronous, Request-Response
'
' === 分布式特性 ===
' @cap-focus: AP (configurable)
' @consistency-model: Eventual Consistency (configurable)
' @consensus-algorithm: Raft, Leader Election
' @partition-strategy: Hash-based, Key-based, Custom partitioning
'
' === 性能与扩展 ===
' @scale: Medium to Large (1K-100K users, 100-10K QPS)
' @scalability: Horizontal scaling, Auto-scaling, Load balancing
' @performance-metrics: Latency: <100ms p99, High throughput
' @optimization-techniques: Caching, Indexing, Connection pooling, Batch processing
' @throughput: High (100K+ requests/second)
' @latency: Low (<100ms p99)
'
' === 可靠性 ===
' @reliability: Replication, Redundancy, Health checks, Automatic recovery
' @fault-tolerance: Replication, Failover, Health monitoring, Graceful degradation
' @disaster-recovery: Multi-datacenter replication, Backup strategies, RPO/RTO management
' @availability: 99.99% (4 nines)
' @data-durability: 99.999999999% (11 nines) with proper replication
'
' === 安全性 ===
' @security-features: Authentication, Firewall
' @authentication: OAuth 2.0, JWT, API Keys, SASL
' @authorization: RBAC (Role-Based Access Control), ACLs, Policy-based
' @encryption: TLS (in-transit), Optional encryption at rest
' @compliance: GDPR-ready, SOC2, HIPAA-compatible, PCI-DSS
'
' === 存储 ===
' @storage-type: File Storage, Log Storage
' @database-type: Polyglot (SQL + NoSQL)
' @caching-strategy: Cache-aside, Write-through, TTL-based expiration
' @data-persistence: Disk-based with WAL, Configurable durability, Snapshot backups
'
' === 监控运维 ===
' @monitoring: Prometheus, Grafana, Custom metrics, Health checks
' @logging: Centralized logging (ELK/Splunk), Structured logs, Log aggregation
' @alerting: Prometheus Alertmanager, PagerDuty, Custom alerts, SLA monitoring
' @observability: Metrics (RED/USE), Logs, Distributed tracing (Jaeger/Zipkin)
'
' === 部署 ===
' @deployment: Cloud-native
' @infrastructure: Cloud, On-premise, Hybrid, Multi-cloud
' @cloud-provider: AWS, Azure, GCP, Cloud-agnostic
' @containerization: Docker-ready, Container-friendly
'
' === 成本 ===
' @cost-factors: Compute instances, Storage costs, Network bandwidth, Licensing
' @cost-optimization: Reserved instances, Auto-scaling, Storage tiering, Compression, Resource right-sizing
' @resource-usage: CPU: Medium-High, Memory: Medium-High, Disk I/O: High, Network: Medium
'
' === 复杂度 ===
' @complexity: Medium
' @implementation-difficulty: Medium
' @maintenance-complexity: Medium
'
' === 学习 ===
' @difficulty-level: Intermediate
' @learning-value: Medium to High (practical system design)
' @prerequisites: Database fundamentals, SQL/NoSQL
' @related-concepts: CAP theorem
'
' === 数据特征 ===
' @data-volume: Medium to Large (GBs to TBs)
' @data-velocity: Real-time, High-speed streaming
' @data-variety: Structured, Semi-structured (JSON, Avro)
' @data-model: Document, Key-Value, Relational, Time-series
'
' === 集成 ===
' @integration-points: REST APIs, Message queues, Database connectors, Webhooks
' @third-party-services: Cloud storage, CDN, Payment processors, Analytics services
' @external-dependencies: Minimal external dependencies
'
' === 测试 ===
' @testing-strategy: Unit tests, Integration tests, Load tests, Chaos engineering
' @quality-assurance: CI/CD pipelines, Code review, Static analysis, Performance testing
'
' === 版本 ===
' @version: 1.0 (current design)
' @maturity: Production-ready, Battle-tested
' @evolution-stage: Active development, Continuous improvement
'
' === 关联 ===
' @related-files: See other architecture diagrams in the same directory
' @alternatives: Multiple implementation approaches available
' @comparison-with: Traditional monolithic vs distributed approaches
'
' === 实战 ===
' @real-world-examples: Fortune 500 companies, Tech unicorns, Large-scale enterprises
' @companies-using: Many Fortune 500 companies, Tech giants, Startups
' @production-readiness: Production-ready, Battle-tested at scale, Enterprise-grade
' ==================================================


!pragma layout dot
allowmixing

' Define deeper colors
!define PRIMARY_COLOR #E67E22
!define SECONDARY_COLOR #3498DB
!define TERTIARY_COLOR #F1C40F
!define QUATERNARY_COLOR #8E44AD
!define QUINARY_COLOR #16A085
!define P2P_COLOR #27AE60

' Background color
skinparam backgroundColor #CCE8CF

rectangle "Client Devices" as ClientDevices PRIMARY_COLOR {
    component "Web Browser" as WebBrowser
    component "Mobile App" as MobileApp
    component "Desktop App" as DesktopApp
}

rectangle "Frontend Services" as FrontendServices SECONDARY_COLOR {
    component "User Interface" as UI
    component "WebRTC Client" as WebRTCClient
    component "Media Capture" as MediaCapture
}

rectangle "Signaling Server" as SignalingServer TERTIARY_COLOR {
    component "WebSocket Handler" as WebSocketHandler
    component "Session Management" as SessionManagement
    component "Presence Service" as PresenceService
}

rectangle "Media Server" as MediaServer QUATERNARY_COLOR {
    component "SFU (Selective Forwarding Unit)" as SFU
    component "MCU (Multipoint Control Unit)" as MCU
    component "Media Processing" as MediaProcessing
}

rectangle "Backend Services" as BackendServices QUINARY_COLOR {
    component "User Authentication" as UserAuth
    component "Call Management" as CallManagement
    component "Analytics Service" as AnalyticsService
}

database "Database" as DB {
    component "User Profiles" as UserProfiles
    component "Call Logs" as CallLogs
    component "Analytics Data" as AnalyticsData
}

cloud "TURN/STUN Servers" as TURNSTUNServers {
    component "TURN Server" as TURNServer
    component "STUN Server" as STUNServer
}

' Add second client device for P2P connection
rectangle "Client Devices (Peer)" as ClientDevicesPeer PRIMARY_COLOR {
    component "Peer Device" as PeerDevice
}

ClientDevices -[PRIMARY_COLOR,thickness=2]-> FrontendServices : <back:#FFFFFF><color:PRIMARY_COLOR>1. Access</color></back>
FrontendServices -[SECONDARY_COLOR,thickness=2]-> SignalingServer : <back:#FFFFFF><color:SECONDARY_COLOR>2. Establish connection</color></back>
SignalingServer -[TERTIARY_COLOR,thickness=2]-> BackendServices : <back:#FFFFFF><color:TERTIARY_COLOR>3. Authenticate & manage calls</color></back>
BackendServices -[QUINARY_COLOR,thickness=2]-> DB : <back:#FFFFFF><color:QUINARY_COLOR>4. Store/retrieve data</color></back>
FrontendServices -[SECONDARY_COLOR,thickness=2]-> MediaServer : <back:#FFFFFF><color:SECONDARY_COLOR>5. Media transmission</color></back>
MediaServer -[QUATERNARY_COLOR,thickness=2]-> TURNSTUNServers : <back:#FFFFFF><color:QUATERNARY_COLOR>6. NAT traversal</color></back>
SignalingServer -[TERTIARY_COLOR,thickness=2]-> MediaServer : <back:#FFFFFF><color:TERTIARY_COLOR>7. Coordinate media flow</color></back>

' Add P2P connection
ClientDevices <-[P2P_COLOR,thickness=2]-> ClientDevicesPeer : <back:#FFFFFF><color:P2P_COLOR>8. P2P Communication</color></back>

note right of ClientDevices
  Supports various client types
  for wide accessibility
end note

note bottom of FrontendServices
  Handles user interactions and
  media capture/rendering
end note

note right of SignalingServer
  Manages real-time communication
  setup and tear-down
end note

note right of MediaServer
  Optimizes media routing and
  processing for scalability
end note

note bottom of BackendServices
  Manages user accounts, call
  records, and system analytics
end note

note bottom of TURNSTUNServers
  Facilitates peer connections
  through firewalls and NATs
end note

note bottom of ClientDevices
  Direct P2P connection established
  after initial signaling
end note

@enduml
