@startuml Optimized Cross-Datacenter Distributed File System Architecture
' ==================== Enhanced Metadata ====================
' === 基础分类 ===
' @category: infrastructure
' @subcategory: load-balancing
' @tags: #load-balancer, #high-availability, #traffic-distribution
' @description: Cross Datacenter Distributed File System Architecture With Consistency Fault Tolerance And Global Load Balancing
'
' === 应用场景 ===
' @application: General
' @industry: General, Enterprise
' @use-cases: System Monitoring
' @business-value: Improved scalability, High availability, Better performance, Cost efficiency
'
' === 技术栈 ===
' @tech-stack: Redis
' @programming-languages: Go, JavaScript/Node.js
' @frameworks: Framework-agnostic
' @protocols: HTTP/REST
' @apis: REST API
'
' === 架构模式 ===
' @pattern: Layered Architecture, Client-Server
' @design-pattern: Observer, Producer-Consumer, Repository, Factory
' @data-flow: Bidirectional, Request-Response
' @communication-style: Asynchronous, Synchronous
'
' === 分布式特性 ===
' @cap-focus: CP (Consistency + Partition Tolerance)
' @consistency-model: Eventual Consistency (configurable)
' @consensus-algorithm: ZAB
' @partition-strategy: Hash-based, Key-based, Custom partitioning
'
' === 性能与扩展 ===
' @scale: Medium to Large (1K-100K users, 100-10K QPS)
' @scalability: Horizontal scaling, Auto-scaling, Load balancing
' @performance-metrics: Response time: <200ms p95, 10K+ QPS
' @optimization-techniques: Caching, Sharding/Partitioning
' @throughput: Medium to High (10K-100K requests/second)
' @latency: Medium (<200ms p95)
'
' === 可靠性 ===
' @reliability: Replication, Redundancy, Health checks, Automatic recovery
' @fault-tolerance: Replication
' @disaster-recovery: Multi-datacenter replication, Backup strategies, RPO/RTO management
' @availability: 99.99% (4 nines)
' @data-durability: 99.999999999% (11 nines) with proper replication
'
' === 安全性 ===
' @security-features: Authentication, Authorization, Encryption, Audit logging
' @authentication: OAuth 2.0, JWT, API Keys, SASL
' @authorization: RBAC (Role-Based Access Control), ACLs, Policy-based
' @encryption: TLS (in-transit), Optional encryption at rest
' @compliance: GDPR-ready, SOC2, HIPAA-compatible, PCI-DSS
'
' === 存储 ===
' @storage-type: Block Storage, File Storage
' @database-type: In-Memory
' @caching-strategy: Cache-aside, Write-through, TTL-based expiration
' @data-persistence: Disk-based with WAL, Configurable durability, Snapshot backups
'
' === 监控运维 ===
' @monitoring: Prometheus, Grafana, Custom metrics, Health checks
' @logging: Centralized logging (ELK/Splunk), Structured logs, Log aggregation
' @alerting: Prometheus Alertmanager, PagerDuty, Custom alerts, SLA monitoring
' @observability: Metrics (RED/USE), Logs, Distributed tracing (Jaeger/Zipkin)
'
' === 部署 ===
' @deployment: Cloud-native
' @infrastructure: Cloud, On-premise, Hybrid, Multi-cloud
' @cloud-provider: AWS, Azure, GCP, Cloud-agnostic
' @containerization: Docker-ready, Container-friendly
'
' === 成本 ===
' @cost-factors: Compute instances, Storage costs, Network bandwidth, Licensing
' @cost-optimization: Reserved instances, Auto-scaling, Storage tiering, Compression, Resource right-sizing
' @resource-usage: CPU: Medium-High, Memory: Medium-High, Disk I/O: High, Network: Medium
'
' === 复杂度 ===
' @complexity: Very High
' @implementation-difficulty: High to Very High
' @maintenance-complexity: High
'
' === 学习 ===
' @difficulty-level: Expert
' @learning-value: Very High (advanced distributed systems concepts)
' @prerequisites: Database fundamentals, SQL/NoSQL
' @related-concepts: CAP theorem, Replication strategies, Data partitioning, Caching strategies, Cache invalidation
'
' === 数据特征 ===
' @data-volume: Medium to Large (GBs to TBs)
' @data-velocity: Near real-time, Mixed batch and streaming
' @data-variety: Structured, Semi-structured (JSON, Avro)
' @data-model: Document, Key-Value, Relational, Time-series
'
' === 集成 ===
' @integration-points: REST APIs, Message queues, Database connectors, Webhooks
' @third-party-services: Cloud storage, CDN, Payment processors, Analytics services
' @external-dependencies: ZooKeeper
'
' === 测试 ===
' @testing-strategy: Unit tests, Integration tests, Load tests, Chaos engineering
' @quality-assurance: CI/CD pipelines, Code review, Static analysis, Performance testing
'
' === 版本 ===
' @version: 1.0 (current design)
' @maturity: Production-ready, Battle-tested
' @evolution-stage: Active development, Continuous improvement
'
' === 关联 ===
' @related-files: See other architecture diagrams in the same directory
' @alternatives: Multiple implementation approaches available
' @comparison-with: Traditional monolithic vs distributed approaches
'
' === 实战 ===
' @real-world-examples: Fortune 500 companies, Tech unicorns, Large-scale enterprises
' @companies-using: Many Fortune 500 companies, Tech giants, Startups
' @production-readiness: Production-ready, Battle-tested at scale, Enterprise-grade
' ==================================================


!define RECTANGLE rectangle
!define DATABASE database
!define CLOUD cloud

skinparam backgroundColor #F0F0F0
skinparam handwritten false
skinparam monochrome false
skinparam defaultFontName Arial
skinparam defaultFontSize 20
skinparam roundCorner 10
skinparam ArrowColor #2C3E50
skinparam ArrowThickness 1.5
skinparam linetype ortho

allowmixing

' Global Components
CLOUD "Global Load Balancer" as GLB #D6EAF8 {
    component "Geo-aware Routing" as GeoRouting
    component "Request Distribution" as ReqDist
}

RECTANGLE "Global Metadata Management" as GMM #AED6F1 {
    component "Cross-DC Metadata Sync" as MetaSync
    component "Global Namespace" as GlobalNS
}

RECTANGLE "Global Admin & Monitoring" as GAM #D5F5E3 {
    component "Cross-DC Monitoring" as CrossDCMon
    component "Disaster Recovery" as DR
    component "Configuration Management" as ConfigMgmt
}

' Data Center 1
RECTANGLE "Data Center 1" as DC1 #FDEBD0 {
    ' Client
    rectangle "Client" as Client1 #A9CCE3

    ' Load Balancer Cluster
    RECTANGLE "Load Balancer Cluster" as LB1 #F5B041 {
        component "Health Check" as HealthCheck1
        component "Request Router" as RequestRouter1
    }

    ' Caching Layer
    RECTANGLE "Caching Layer" as CacheLayer1 #85C1E9 {
        DATABASE "Redis Cluster" as RedisCache1 {
            note right
                Cache Structure:
                1. File chunk location:
                   Key: "chunk:{file_path}:{chunk_id}"
                   Value: Node ID storing the chunk
                2. File metadata:
                   Key: "metadata:{file_path}"
                   Value: Serialized file metadata
            end note
        }
    }

    ' Name Node Cluster
    RECTANGLE "Name Node Cluster" as NameNodeCluster1 #82E0AA {
        DATABASE "Metadata Storage\n(ZooKeeper)" as MetadataStorage1 {
            note right
                Stored Metadata:
                1. File system tree:
                   - Directory structure
                   - File names and attributes
                2. Block mappings:
                   - File to data block mapping
                   - Data block to storage node mapping
                3. Node status:
                   - Health status of data nodes
                   - Storage capacity and usage
                   - Current load information
            end note
        }
        component "File System Manager" as FSManager1
        component "Block Manager" as BlockManager1
        component "Replication Manager" as ReplicationManager1
        component "Data Node Manager" as DataNodeManager1
    }

    ' Data Node Clusters
    RECTANGLE "Data Node Cluster" as DataNodeCluster1 #F1948A {
        DATABASE "Primary Storage" as PrimaryStorage1 {
            note right: "Sharding Key: file_id % 2 == 0"
        }
        DATABASE "Replica Storage" as ReplicaStorage1 {
            note right: "Replica of DC2"
        }
    }

    ' Read Coordinator
    component "Read Coordinator" as ReadCoord1 #FFA07A
}

' Data Center 2 (more detailed now)
RECTANGLE "Data Center 2" as DC2 #FDEBD0 {
    rectangle "Client" as Client2 #A9CCE3
    RECTANGLE "Load Balancer Cluster" as LB2 #F5B041
    RECTANGLE "Caching Layer" as CacheLayer2 #85C1E9
    RECTANGLE "Name Node Cluster" as NameNodeCluster2 #82E0AA {
        DATABASE "Metadata Storage\n(ZooKeeper)" as MetadataStorage2
    }
    RECTANGLE "Data Node Cluster" as DataNodeCluster2 #F1948A {
        DATABASE "Primary Storage" as PrimaryStorage2 {
            note left: "Sharding Key: file_id % 2 == 1"
        }
        DATABASE "Replica Storage" as ReplicaStorage2 {
            note left: "Replica of DC1"
        }
    }
    component "Read Coordinator" as ReadCoord2 #FFA07A
}

' Connections
Client1 --> GLB : "1. Client Request"
Client2 --> GLB : "1. Client Request"
GLB --> LB1 : "2. Route to nearest DC"
GLB --> LB2 : "2. Route to nearest DC"
LB1 --> ReadCoord1 : "3a. Read Request"
LB1 --> NameNodeCluster1 : "3b. Write Request"
ReadCoord1 --> CacheLayer1 : "4a. Check Cache"
ReadCoord1 --> NameNodeCluster1 : "4b. Get Metadata"
NameNodeCluster1 --> PrimaryStorage1 : "5a. Write Data"
ReadCoord1 --> ReplicaStorage1 : "5b. Read Data"
CacheLayer1 --> NameNodeCluster1 : "6. Cache Miss"
PrimaryStorage1 --> ReplicaStorage2 : "7. Replicate Data"
NameNodeCluster1 <--> GMM : "8a. Sync Metadata"
NameNodeCluster2 <--> GMM : "8b. Sync Metadata"
NameNodeCluster1 <--> NameNodeCluster2 : "9. Cross-DC Metadata Sync"
DataNodeCluster1 <--> DataNodeCluster2 : "10. Cross-DC Data Replication"
GAM --> DC1 : "11. Monitor & Manage"
GAM --> DC2 : "11. Monitor & Manage"

' Additional notes for explanation
note top of GLB
  Global Load Balancer provides 
  geo-aware routing and ensures 
  even distribution of requests 
  across data centers
end note

note bottom of GMM
  Global Metadata Management 
  ensures consistency of metadata 
  across data centers and manages 
  the global namespace
end note

note bottom of GAM
  Global Admin & Monitoring oversees 
  system health across all data centers, 
  manages configuration, and handles 
  disaster recovery
end note

note right of DataNodeCluster1
  Read-Write Separation:
  - Write requests go to Primary Storage
  - Read requests are served by Replica Storage
  - Cross-DC replication ensures data consistency
end note

@enduml
