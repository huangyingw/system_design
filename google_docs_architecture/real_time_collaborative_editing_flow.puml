@startuml Real-time Collaborative Editing Flow
' ==================== Metadata ====================
' @category: database
' @tags: #database, #websocket
' @application: General
' @tech-stack: WebSocket
' @pattern: Architecture
' @description: Real Time Collaborative Editing Flow
' ==================================================


skinparam backgroundColor #FEFEFE
skinparam handwritten false
skinparam monochrome false
skinparam shadowing false
skinparam defaultFontName Arial
skinparam defaultFontSize 14
skinparam sequenceArrowThickness 2
skinparam roundcorner 10
skinparam maxMessageSize 200

skinparam sequence {
    ArrowColor #2C3E50
    ActorBorderColor #2980B9
    LifeLineBorderColor #2980B9
    LifeLineBackgroundColor #A9CCE3
    
    ParticipantBorderColor #2980B9
    ParticipantBackgroundColor #E8F8F5
    ParticipantFontName Arial
    ParticipantFontSize 16
    ParticipantFontColor #2C3E50
    
    ActorBackgroundColor #85C1E9
    ActorFontColor #2C3E50
    ActorFontSize 16
    ActorFontName Arial
}

actor "User A" as UserA
actor "User B" as UserB
participant "Client A" as ClientA
participant "Client B" as ClientB
participant "WebSocket Server" as WSS
participant "Operational Transform Engine" as OTE
participant "Conflict Resolution" as CR
participant "Document Service" as DS
database "Document DB" as DB

UserA -> ClientA: Edit document
activate ClientA

ClientA -> ClientA: Generate local change
ClientA -> WSS: Send change
activate WSS

WSS -> OTE: Apply operational transform
activate OTE

OTE -> CR: Check for conflicts
activate CR

CR -> DS: Fetch latest document state
activate DS

DS -> DB: Read document
activate DB
DB --> DS: Return document
deactivate DB

DS --> CR: Return latest state
deactivate DS

CR -> CR: Resolve conflicts (if any)
CR --> OTE: Return resolved change
deactivate CR

OTE -> WSS: Return transformed change
deactivate OTE

WSS -> ClientB: Broadcast change to other clients
WSS -> ClientA: Acknowledge change
deactivate WSS

ClientA -> ClientA: Apply change locally
ClientA --> UserA: Update UI
deactivate ClientA

ClientB -> ClientB: Apply received change
ClientB -> UserB: Update UI

@enduml
